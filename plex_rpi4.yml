- name: Plex Raspberry Pi
  hosts: localhost
  connection: local
  gather_facts: no
  become: true
  
  tasks:
  - name: Update Cache
    apt:
      update_cache: yes

  - name: Upgrade all packages to the latest version
    apt:
      upgrade: dist
      install_recommends: yes

  - name: Remove useless packages from the cache
    apt:
      autoclean: yes

  - name: Remove dependencies that are no longer required
    apt:
      autoremove: yes

  - name: Install http transport for apt
    apt:
      name: apt-transport-https
      state: present
      update_cache: true
      install_recommends: yes
 
  - name: Add Plex Key
    apt_key:
      url: https://downloads.plex.tv/plex-keys/PlexSign.key
      state: present

  - name: Add Plex repo
    apt_repository:
      repo: deb https://downloads.plex.tv/repo/deb public main
      state: present
      filename: plexmediaserver

  - name: Update Cache
    apt:
      update-cache: yes

  - name: Install http transport for apt
    apt:
      name: plexmediaserver
      state: present
      update_cache: true
      install_recommends: yes

  - name: Enable SSH
    service:
      name: ssh
      enabled: yes
      state: started