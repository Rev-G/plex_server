- name: Plex Raspberry Pi
  hosts: plex
  become: true
  
  tasks:
  - name: Update Cache
    apt:
      update_cache: yes

  - name: Upgrade all packages to the latest version
    apt:
      upgrade: dist
      install_recommends: yes

  - name: Remove useless packages from the cache
    apt:
      autoclean: yes

  - name: Remove dependencies that are no longer required
    apt:
      autoremove: yes

  - name: Install http transport for apt
    apt:
      name: apt-transport-https
      state: present
      update_cache: true
      install_recommends: yes

  - name: Install exFat fuse support
    apt:
      name: exfat-fuse
      state: present
      update_cache: true
      install_recommends: yes

  - name: Install exFat utils
    apt:
      name: exfat-utils
      state: present
      update_cache: true
      install_recommends: yes
 
  - name: Add Plex Key
    apt_key:
      url: https://downloads.plex.tv/plex-keys/PlexSign.key
      state: present

  - name: Add Plex repo
    apt_repository:
      repo: deb https://downloads.plex.tv/repo/deb public main
      state: present
      filename: plexmediaserver

  - name: Update Cache
    apt:
      update-cache: yes

  - name: Install Plex Media Server
    apt:
      name: plexmediaserver
      state: present
      update_cache: true
      install_recommends: yes

##need to add a dir /media/mediaplus for the external exfat drive
##use lsusb and lsblk to find out where the drive is being seen
##mount it with
#sudo mount -t exfat /dev/sda2 /media/mediaplus
##verify the mount
#df -h 
##
#sudo umount /dev/sda2
