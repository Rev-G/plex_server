- name: Plex Raspberry Pi Install
  hosts: plex

  tasks:
    - name: Update Cache
      ansible.builtin.apt:
        update_cache: true

    - name: Upgrade all packages to the latest version
      ansible.builtin.apt:
        upgrade: dist
        install_recommends: true

    - name: Remove useless packages from the cache
      ansible.builtin.apt:
        autoclean: true

    - name: Remove dependencies that are no longer required
      ansible.builtin.apt:
        autoremove: true

    - name: Install http transport for apt
      ansible.builtin.apt:
        name: apt-transport-https
        state: present
        update_cache: true
        install_recommends: true

    - name: Install exFat fuse support
      ansible.builtin.apt:
        name: exfat-fuse
        state: present
        update_cache: true
        install_recommends: true

    - name: Install exFat utils
      ansible.builtin.apt:
        name: exfatprogs
        state: present
        update_cache: true
        install_recommends: true

    # - name: Add Plex Key
    #   ansible.builtin.apt_key:
    #     url: https://downloads.plex.tv/plex-keys/PlexSign.key
    #     state: present

    - name: Download Plex Key
      ansible.builtin.get_url:
        url: https://downloads.plex.tv/plex-keys/PlexSign.key
        dest: /etc/apt/trusted.gpg.d/plexsign.asc
        mode: '0644'

    - name: Add Plex repo
      ansible.builtin.apt_repository:
        repo: deb https://downloads.plex.tv/repo/deb public main
        state: present
        filename: plexmediaserver

    - name: Update Cache
      ansible.builtin.apt:
        update-cache: true

    - name: Install Plex Media Server
      ansible.builtin.apt:
        name: plexmediaserver
        state: present
        update_cache: true
        install_recommends: true

    - name: Create media mount directory
      ansible.builtin.file:
        path: /media/mediaplus
        mode: '0755'
        state: directory

    - name: Mount media drive
      ansible.posix.mount:
        path: /media/mediaplus
        src: LABEL=mediaplus
        fstype: exfat
        opts: defaults
        state: mounted
